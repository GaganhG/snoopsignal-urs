name: Upload Reddit Data to Airtable

on:
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Extract and upload to Airtable
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        run: |
          import json, os, requests, zipfile

          # Unzip the scrape output
          with zipfile.ZipFile("reddit_scrape_output.zip", "r") as zip_ref:
              zip_ref.extractall("output")

          with open("output/output.json", "r", encoding="utf-8") as f:
              posts = json.load(f)

          AIRTABLE_API_KEY = os.getenv("AIRTABLE_API_KEY")
          BASE_ID = os.getenv("AIRTABLE_BASE_ID")
          TABLE_NAME = "Problems"

          headers = {
              "Authorization": f"Bearer {AIRTABLE_API_KEY}",
              "Content-Type": "application/json"
          }

          url = f"https://api.airtable.com/v0/{BASE_ID}/{TABLE_NAME}"

          for post in posts:
              data = {
                  "fields": {
                      "Name": post["title"],
                      "Notes": post["body"],
                      "Lang": "EN"
                  }
              }
              r = requests.post(url, headers=headers, json=data)
              print(f"Uploaded: {post['title']} - Status {r.status_code}")

